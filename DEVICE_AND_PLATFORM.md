# Device and Platform Configuration Guide

This document explains which parts of the Jersey Number Recognition pipeline are device-specific or platform-specific, and how to configure the project for different machines and operating systems.

## Quick Start

### For a New Machine (Same OS)

1. Clone or copy the project to the new machine
2. Set environment variables (optional, see below) OR let the code auto-detect paths
3. Run setup to create conda environments
4. The pipeline will automatically detect and use available GPU (CUDA/MPS) or fall back to CPU

### For a Different OS (Windows ↔ Mac/Linux)

1. Follow "New Machine" steps above
2. The code automatically handles:
   - Python executable paths (`python.exe` on Windows, `python` on Unix)
   - Path separators (backslash vs forward slash)
   - DataLoader worker counts (0 on Windows, 4 on Unix)
   - GPU type (CUDA on NVIDIA, MPS on Apple Silicon, CPU otherwise)

---

## 1. Device-Specific Configuration

These settings are tied to your specific machine and may need adjustment when moving the project.

### 1.1 Project Paths

**File:** `configuration.py`

The following paths are auto-detected but can be overridden:

| Variable       | Default                                              | Environment Override    | Purpose                              |
|----------------|------------------------------------------------------|-------------------------|--------------------------------------|
| `_main_repo`   | Directory containing `configuration.py`              | `JERSEY_PROJECT_ROOT`   | Project root for all relative paths  |
| `_conda_base`  | `~/miniconda3/envs` (both Windows and Unix)          | `JERSEY_CONDA_BASE`     | Location of conda environments       |

**To override:** Set environment variables before running the pipeline:

```bash
# Windows (PowerShell)
$env:JERSEY_PROJECT_ROOT = "D:\MyProjects\Jersey-Number-Recognition-Project"
$env:JERSEY_CONDA_BASE = "D:\Anaconda\envs"

# Mac/Linux
export JERSEY_PROJECT_ROOT="/Users/myname/projects/Jersey-Number-Recognition-Project"
export JERSEY_CONDA_BASE="/opt/homebrew/Caskroom/miniconda/base/envs"
```

**Default behavior:** If environment variables are not set, the project root is automatically detected from the location of `configuration.py`, and conda environments are assumed to be in the standard location (`~/miniconda3/envs`).

### 1.2 GPU Detection

The pipeline automatically detects the best available device:

| Priority | Device Type    | When Used                              | Platforms            |
|----------|----------------|----------------------------------------|----------------------|
| 1        | CUDA           | NVIDIA GPU detected                    | Windows, Linux       |
| 2        | MPS            | Apple Silicon Mac                      | macOS (M1/M2/M3)     |
| 3        | CPU            | No GPU available or GPU not supported  | All platforms        |

**Files with automatic device detection:**
- `pose.py` (line 52-57)
- `str.py` (line 256-262)
- `legibility_classifier.py` (line 344-352, 366-379)
- `centroid_reid.py` (line 59-75)

**No configuration needed** - the code automatically selects the best device.

### 1.3 Generated Files with Absolute Paths

**File:** `pose_input.json` (generated by `helpers.py`)

This JSON file contains **absolute paths** to image files. If you move the project to a different machine or drive:

- **Option 1 (Recommended):** Re-run the "Generating json for pose" step on the new machine
- **Option 2:** Ensure the entire project is at the exact same absolute path on both machines

---

## 2. Platform-Specific Differences (Windows vs Mac/Linux)

The following differences are **automatically handled** by the code:

### 2.1 Python Executables

| OS          | Executable Name | Path Structure                     |
|-------------|-----------------|-------------------------------------|
| Windows     | `python.exe`    | `envs\<env_name>\python.exe`       |
| Mac/Linux   | `python`        | `envs/<env_name>/bin/python`       |

The code automatically uses the correct name via `os.name` detection in `configuration.py`.

### 2.2 DataLoader Workers

| OS          | Default `num_workers` | Reason                                       |
|-------------|-----------------------|----------------------------------------------|
| Windows     | 0                     | Avoid multiprocessing spawn overhead         |
| Mac/Linux   | 4                     | Benefit from parallel data loading           |

**Files with automatic worker adjustment:**
- `str.py` (line 249-251)
- `legibility_classifier.py` (always uses 0 for inference, 4 for training)

### 2.3 Hidden Files

The code filters out macOS hidden files (`.DS_Store`) and other dotfiles in all directory listings:

**Files with dotfile filtering:**
- `main.py` (line 11-12, uses `list_dirs()` helper)
- `centroid_reid.py` (line 88)
- `gaussian_outliers.py` (line 17-18)

No Windows-specific hidden file handling is needed.

### 2.4 CUDA vs MPS vs CPU

| Platform            | GPU Support | Notes                                                          |
|---------------------|-------------|----------------------------------------------------------------|
| Windows (NVIDIA)    | CUDA        | Requires PyTorch with CUDA support (e.g., `cu128`)            |
| Linux (NVIDIA)      | CUDA        | Same as Windows                                                |
| macOS (Apple Si)    | MPS         | Supported in PyTorch 2.0+; some ops may fall back to CPU      |
| macOS (Intel)       | CPU only    | No GPU acceleration                                            |
| Any (no GPU)        | CPU only    | Slow but works everywhere                                      |

The code automatically enables the appropriate acceleration backend. `cudnn.benchmark` is only enabled on CUDA (ignored on MPS/CPU).

---

## 3. What to Check When Moving the Project

### Checklist for New Machine

- [ ] Conda environments created (run `setup.py`)
- [ ] Conda environment location matches system (or set `JERSEY_CONDA_BASE`)
- [ ] Project path correct (or set `JERSEY_PROJECT_ROOT`)
- [ ] PyTorch version matches GPU (CUDA for NVIDIA, CPU/MPS for Mac)
- [ ] Pose input JSON regenerated if absolute paths changed

### Checklist for Different OS

- [ ] All items from "New Machine" checklist
- [ ] Python executable paths auto-detected (Windows `.exe` vs Unix no extension)
- [ ] DataLoader workers auto-adjusted for OS
- [ ] GPU type auto-detected (CUDA/MPS/CPU)

---

## 4. Advanced: Manual Path Configuration

If you need to manually set paths (not recommended), edit `configuration.py`:

```python
# Override auto-detection
_main_repo = r'/custom/path/to/project'  # Use raw string on Windows
_conda_base = r'/custom/path/to/conda/envs'
```

For cross-platform projects, prefer environment variables or the default auto-detection.

---

## 5. Troubleshooting

### "FileNotFoundError: python.exe not found"
- Check that conda environments are created: `conda env list`
- Set `JERSEY_CONDA_BASE` to the correct path
- Verify environment names: `vitpose2`, `parseq2`, `jersey`

### "CUDA not available" on machine with NVIDIA GPU
- Ensure PyTorch is installed with CUDA support: `python -c "import torch; print(torch.cuda.is_available())"`
- Reinstall PyTorch with correct CUDA version (see `setup.py`)

### "Model inference very slow"
- Check device being used (look for "using GPU" vs "using CPU" in logs)
- On Mac, ensure PyTorch 2.0+ for MPS support
- On Windows, `num_workers=0` is expected (doesn't affect GPU performance)

### "Path not found" errors
- Ensure `_main_repo` points to the project root (contains `main.py`, `configuration.py`, etc.)
- Check that `data/` and `models/` subdirectories exist
- Regenerate pose JSON if you moved the project

---

## 6. Summary Table

| Aspect                  | Auto-Detected | Configurable           | Cross-Platform |
|-------------------------|---------------|------------------------|----------------|
| Project root path       | ✅ Yes        | `JERSEY_PROJECT_ROOT`  | ✅ Yes         |
| Conda environments path | ✅ Yes        | `JERSEY_CONDA_BASE`    | ✅ Yes         |
| Python executable name  | ✅ Yes        | N/A                    | ✅ Yes         |
| GPU type (CUDA/MPS/CPU) | ✅ Yes        | N/A                    | ✅ Yes         |
| DataLoader workers      | ✅ Yes        | Command-line args      | ✅ Yes         |
| Dotfile filtering       | ✅ Yes        | N/A                    | ✅ Yes         |
| Pose input JSON paths   | ❌ No         | Must regenerate        | ⚠️ Regenerate  |

✅ = Fully automatic  
⚠️ = Requires action when moving project  
❌ = Not automatic (must regenerate)
